---
lp: 2508
title: Alchemix Self-Repaying Loans Standard
description: Self-repaying loans protocol enabling users to mint synthetic tokens against yield-bearing collateral
author: Lux Network Team (@luxfi)
discussions-to: https://github.com/luxfi/lps/discussions
status: Draft
type: Standards Track
category: LRC
created: 2025-12-14
requires: 2000, 6022
---

## Abstract

This LP defines the Alchemix Self-Repaying Loans standard for Lux Network, forked and adapted from Alchemix Finance V2. The protocol enables users to deposit yield-bearing collateral and mint synthetic tokens (alUSD, alETH, alLUX) representing future yield. Loans repay themselves automatically over time through yield generated by the deposited collateral. Unlike traditional lending protocols, users face no liquidation risk as debt is always fully collateralized. This implementation includes Lux-specific adaptations: native LUX staking as collateral, cross-chain synthetic tokens via Warp/Teleport messaging, and integration with Lux DeFi yield sources.

## Motivation

Traditional DeFi lending protocols require:
1. Active debt management to avoid liquidation
2. Interest payments that compound over time
3. Constant monitoring of collateralization ratios
4. Risk of total collateral loss during market volatility

Self-repaying loans solve these problems by:
1. **Zero Liquidation Risk**: Debt is always backed by yield-bearing collateral at or above 1:1
2. **Passive Repayment**: Yield automatically reduces debt without user intervention
3. **Capital Efficiency**: Access future yield immediately without selling assets
4. **Predictable Outcomes**: Known maximum debt duration based on yield rates

### Lux-Specific Benefits

1. **Native LUX Staking Integration**: Mint alLUX against staked LUX, accessing staking yield upfront
2. **Cross-Chain Synthetics**: alUSD/alETH/alLUX portable across Lux chains via Warp messaging
3. **High-Performance Settlement**: Sub-second finality for transmuter operations
4. **Post-Quantum Ready**: Future migration path for synthetic token signatures (LP-4200)

## Specification

### Core Components

#### 1. AlchemistV2 - Main Lending Contract

The Alchemist is the core contract managing deposits, debt, and yield harvesting.

**Location**: `/Users/z/work/lux/standard/src/alcx2/contracts/AlchemistV2.sol`

```solidity
interface IAlchemistV2 {
    // Version
    function version() external view returns (string memory);  // "2.2.7"

    // Immutables
    function debtToken() external view returns (address);       // alUSD/alETH/alLUX

    // Configuration
    function minimumCollateralization() external view returns (uint256);  // e.g., 2e18 = 200%
    function protocolFee() external view returns (uint256);               // Basis points

    // Core Operations
    function deposit(address yieldToken, uint256 amount, address recipient)
        external returns (uint256 shares);

    function depositUnderlying(
        address yieldToken,
        uint256 amount,
        address recipient,
        uint256 minimumAmountOut
    ) external returns (uint256 shares);

    function withdraw(address yieldToken, uint256 shares, address recipient)
        external returns (uint256 amount);

    function mint(uint256 amount, address recipient) external;

    function burn(uint256 amount, address recipient) external returns (uint256);

    function repay(address underlyingToken, uint256 amount, address recipient)
        external returns (uint256);

    function liquidate(address yieldToken, uint256 shares, uint256 minimumAmountOut)
        external returns (uint256);

    function harvest(address yieldToken, uint256 minimumAmountOut) external;

    // Account State
    function accounts(address owner) external view returns (int256 debt, address[] memory depositedTokens);
    function positions(address owner, address yieldToken) external view returns (uint256 shares, uint256 lastAccruedWeight);
}
```

**Key Parameters**:
| Parameter | Default Value | Description |
|-----------|--------------|-------------|
| `minimumCollateralization` | 2e18 (200%) | Minimum collateral ratio |
| `protocolFee` | 1000 (10%) | Fee on harvested yield |
| `BPS` | 10000 | Basis points constant |
| `FIXED_POINT_SCALAR` | 1e18 | Fixed-point precision |

#### 2. TransmuterV2 - Synthetic-to-Underlying Exchange

The Transmuter allows 1:1 exchange of synthetic tokens for underlying assets, funded by repayments and liquidations.

**Location**: `/Users/z/work/lux/standard/src/alcx2/contracts/TransmuterV2.sol`

```solidity
interface ITransmuterV2 {
    function version() external view returns (string memory);  // "2.2.0"

    // Synthetic token operations
    function deposit(uint256 amount, address owner) external;
    function withdraw(uint256 amount, address recipient) external;
    function claim(uint256 amount, address recipient) external;

    // Exchange mechanism
    function exchange(uint256 amount) external;

    // View functions
    function getUnexchangedBalance(address owner) external view returns (uint256);
    function getExchangedBalance(address owner) external view returns (uint256);
    function getClaimableBalance(address owner) external view returns (uint256);

    // Token addresses
    function syntheticToken() external view returns (address);
    function underlyingToken() external view returns (address);
}
```

**Transmutation Mechanism**:
1. Users deposit synthetic tokens (alUSD) to queue for exchange
2. As underlying tokens flow in (from repayments/liquidations), they are distributed pro-rata
3. Users claim underlying tokens as their share becomes available
4. Guarantees 1:1 exchange rate over time

#### 3. AlchemicTokenV2 - Synthetic Token

ERC20-compatible synthetic tokens with flash mint capability.

**Location**: `/Users/z/work/lux/standard/src/alcx2/contracts/AlchemicTokenV2.sol`

```solidity
interface IAlchemicToken is IERC20, IERC3156FlashLender {
    // Minting (whitelisted only)
    function mint(address recipient, uint256 amount) external;

    // Burning
    function burn(uint256 amount) external;
    function burnFrom(address account, uint256 amount) external;

    // Flash minting (ERC-3156)
    function maxFlashLoan(address token) external view returns (uint256);
    function flashFee(address token, uint256 amount) external view returns (uint256);
    function flashLoan(
        IERC3156FlashBorrower receiver,
        address token,
        uint256 amount,
        bytes calldata data
    ) external returns (bool);

    // Access control
    function setWhitelist(address minter, bool state) external;
    function pauseMinter(address minter, bool state) external;
}
```

**Flash Mint Parameters**:
| Parameter | Default | Description |
|-----------|---------|-------------|
| `flashMintFee` | 0 | Fee in basis points |
| `maxFlashLoanAmount` | Configurable | Maximum flash loan |

#### 4. Token Adapters - Yield Source Integration

Adapters wrap yield-bearing tokens for integration with the Alchemist.

**Location**: `/Users/z/work/lux/standard/src/alcx2/contracts/interfaces/ITokenAdapter.sol`

```solidity
interface ITokenAdapter {
    function version() external view returns (string memory);
    function token() external view returns (address);           // Yield token
    function underlyingToken() external view returns (address); // Underlying asset
    function price() external view returns (uint256);           // Exchange rate

    function wrap(uint256 amount, address recipient) external returns (uint256 yieldTokens);
    function unwrap(uint256 amount, address recipient) external returns (uint256 underlyingTokens);
}
```

### Lux-Specific Adaptations

#### 5. Cross-Chain Synthetic Tokens

Synthetic tokens are portable across Lux chains using Warp messaging.

**Location**: `/Users/z/work/lux/standard/src/alcx2/contracts/CrossChainCanonicalAlchemicTokenV2.sol`

```solidity
contract CrossChainCanonicalAlchemicTokenV2 is CrossChainCanonicalBase, AlchemicTokenV2Base {
    function initialize(
        string memory name,
        string memory symbol,
        address[] memory _bridgeTokens
    ) public initializer;
}
```

**Cross-Chain Architecture**:
```
C-Chain (Primary)                    Other Lux Chains
+------------------+                 +------------------+
| AlchemistV2      |                 |                  |
| TransmuterV2     |    Warp/       | CrossChainAl-    |
| AlchemicTokenV2  | <----------->  | chemicTokenV2    |
| (Canonical)      |   Teleport     | (Bridged)        |
+------------------+                 +------------------+
```

**Teleport Integration** (LP-6022):
- Synthetic tokens use Warp messaging for cross-chain transfers
- Canonical token on C-Chain, bridged versions on other chains
- Native Interchain Token Transfer (NITT) compatibility

#### 6. Lux Native Token Support

**alLUX - Synthetic LUX**:
- Backed by staked LUX (sLUX) yield
- Enables accessing staking rewards upfront
- Deployed on C-Chain as canonical, bridgeable to all Lux chains

**Yield Sources**:
| Asset | Yield Token | Source | Expected APY |
|-------|-------------|--------|--------------|
| LUX | sLUX | Validator Staking | 4-8% |
| USD | Various | Lux DeFi Protocols | 3-10% |
| ETH | wstETH | Bridged Lido | 3-5% |

### Token Specifications

#### alUSD - Synthetic USD

| Property | Value |
|----------|-------|
| Name | Alchemix USD |
| Symbol | alUSD |
| Decimals | 18 |
| Collateral | USDC, USDT, DAI yield tokens |
| Chain | C-Chain (canonical) |

#### alETH - Synthetic ETH

| Property | Value |
|----------|-------|
| Name | Alchemix ETH |
| Symbol | alETH |
| Decimals | 18 |
| Collateral | wstETH, rETH yield tokens |
| Chain | C-Chain (canonical) |

#### alLUX - Synthetic LUX (Lux Native)

| Property | Value |
|----------|-------|
| Name | Alchemix LUX |
| Symbol | alLUX |
| Decimals | 18 |
| Collateral | sLUX (staked LUX) |
| Chain | C-Chain (canonical) |

### Deployment Configuration

#### Lux Mainnet (Chain ID: 96369)

```solidity
// Core Contracts
address constant ALUSD_ALCHEMIST = 0x...; // AlchemistV2 for alUSD
address constant ALETH_ALCHEMIST = 0x...; // AlchemistV2 for alETH
address constant ALLUX_ALCHEMIST = 0x...; // AlchemistV2 for alLUX

address constant ALUSD_TOKEN = 0x...;      // AlchemicTokenV2
address constant ALETH_TOKEN = 0x...;      // AlchemicTokenV2
address constant ALLUX_TOKEN = 0x...;      // AlchemicTokenV2

address constant ALUSD_TRANSMUTER = 0x...; // TransmuterV2
address constant ALETH_TRANSMUTER = 0x...; // TransmuterV2
address constant ALLUX_TRANSMUTER = 0x...; // TransmuterV2

// Initialization Parameters
struct AlchemistInitParams {
    address debtToken;                    // alUSD/alETH/alLUX
    address admin;                        // Multisig admin
    address transmuter;                   // TransmuterV2 address
    uint256 minimumCollateralization;     // 2e18 (200%)
    uint256 protocolFee;                  // 1000 (10%)
    address protocolFeeReceiver;          // Treasury address
    uint256 mintingLimitMaximum;          // Initial mint limit
    uint256 mintingLimitBlocks;           // Blocks to replenish
    uint256 mintingLimitMinimum;          // Minimum reserve
    address whitelist;                    // Whitelist contract
}
```

#### Gas Costs (Estimated)

| Operation | Gas Cost | USD (@ 25 gwei) |
|-----------|----------|-----------------|
| deposit | ~150,000 | $0.04 |
| depositUnderlying | ~200,000 | $0.05 |
| withdraw | ~120,000 | $0.03 |
| mint | ~100,000 | $0.025 |
| burn | ~80,000 | $0.02 |
| repay | ~150,000 | $0.04 |
| harvest | ~300,000 | $0.075 |
| transmuter.claim | ~100,000 | $0.025 |

### Yield Strategy Architecture

```
User Collateral Flow:
+----------+    deposit    +------------+    wrap    +---------------+
| User     | ------------> | Alchemist  | --------> | Yield Token   |
| (USDC)   |               | V2         |           | (yvUSDC)      |
+----------+               +------------+           +---------------+
                                |                          |
                                | mint alUSD               | yield accrues
                                v                          v
                          +------------+           +---------------+
                          | alUSD      |           | Harvest       |
                          | Token      | <-------- | (keeper)      |
                          +------------+           +---------------+
                                |                          |
                                | credit distributed       |
                                v                          v
                          +------------+           +---------------+
                          | User Debt  |           | Transmuter    |
                          | Decreases  | --------> | Buffer        |
                          +------------+           +---------------+
```

## Rationale

### Fork Choice: Alchemix V2

Alchemix V2 was chosen because:
1. **Battle-tested**: $300M+ TVL on Ethereum mainnet
2. **Audited**: Multiple security audits (Runtime Verification, Code4rena)
3. **Modular**: Clean separation of concerns (Alchemist, Transmuter, Adapters)
4. **Upgradeable**: Proxy pattern enables future improvements

### Minimum Collateralization (200%)

The 200% minimum ensures:
- Synthetic tokens maintain peg under normal conditions
- Sufficient buffer for yield accumulation
- Protection against temporary yield source issues

### Credit Unlock Rate

Harvested yield is distributed over multiple blocks to:
- Prevent front-running of harvest transactions
- Smooth credit distribution
- Enable fair distribution among depositors

### Cross-Chain via Warp

Using Warp/Teleport (LP-6022) for cross-chain synthetics:
- Native Lux interoperability
- No third-party bridge risk
- Consistent security model across chains

## Backwards Compatibility

This standard is compatible with:
- **ERC-20**: All synthetic tokens are standard ERC-20
- **ERC-3156**: Flash loan interface for synthetic tokens
- **LRC-20** (LP-20): Lux token standard compatibility
- **Warp Messaging** (LP-6022): Cross-chain token transfers

Existing Alchemix integrations (DEXs, aggregators, wallets) work without modification.

## Test Cases

### 1. Basic Deposit and Mint

```solidity
function testDepositAndMint() public {
    // Setup: User has 1000 USDC
    uint256 depositAmount = 1000e6;
    usdc.approve(address(alchemist), depositAmount);

    // Deposit underlying (USDC -> yvUSDC)
    uint256 shares = alchemist.depositUnderlying(
        yvUSDC,
        depositAmount,
        address(this),
        depositAmount * 99 / 100  // 1% slippage
    );

    // Mint alUSD (up to 50% of deposit value)
    uint256 mintAmount = 500e18;  // 500 alUSD
    alchemist.mint(mintAmount, address(this));

    // Verify state
    (int256 debt,) = alchemist.accounts(address(this));
    assertEq(debt, int256(mintAmount));
    assertEq(alUSD.balanceOf(address(this)), mintAmount);
}
```

### 2. Self-Repaying Loan

```solidity
function testSelfRepayingLoan() public {
    // Setup: Deposit and mint
    testDepositAndMint();

    // Simulate yield accrual
    vm.roll(block.number + 1000);

    // Harvest yield
    alchemist.harvest(yvUSDC, 0);

    // Verify debt decreased
    (int256 debtAfter,) = alchemist.accounts(address(this));
    assertLt(debtAfter, 500e18);  // Debt reduced by harvested yield
}
```

### 3. Transmuter Exchange

```solidity
function testTransmuterExchange() public {
    // Setup: User has alUSD, wants USDC
    uint256 depositAmount = 1000e18;
    alUSD.approve(address(transmuter), depositAmount);

    // Deposit to transmuter queue
    transmuter.deposit(depositAmount, address(this));

    // Simulate repayments filling transmuter
    vm.prank(alchemistAddress);
    usdc.transfer(address(transmuter), depositAmount / 1e12);  // USDC has 6 decimals
    transmuter.exchange(depositAmount / 1e12);

    // Claim underlying
    uint256 claimable = transmuter.getClaimableBalance(address(this));
    transmuter.claim(claimable, address(this));

    // Verify received USDC
    assertEq(usdc.balanceOf(address(this)), claimable / 1e12);
}
```

### 4. Cross-Chain Transfer

```solidity
function testCrossChainTransfer() public {
    // Setup: User has alUSD on C-Chain
    uint256 amount = 100e18;

    // Initiate cross-chain transfer via Warp
    bytes32 messageId = IWarpMessenger(WARP).sendWarpMessage(
        HANZO_CHAIN_ID,
        abi.encode(address(this), amount)
    );

    // On destination chain: receive and mint bridged alUSD
    // (Handled by CrossChainCanonicalAlchemicTokenV2)
}
```

## Reference Implementation

### Contract Locations

| Contract | Path |
|----------|------|
| AlchemistV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/AlchemistV2.sol` |
| TransmuterV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/TransmuterV2.sol` |
| AlchemicTokenV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/AlchemicTokenV2.sol` |
| CrossChainCanonicalAlchemicTokenV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/CrossChainCanonicalAlchemicTokenV2.sol` |
| TransmuterBuffer | `/Users/z/work/lux/standard/src/alcx2/contracts/TransmuterBuffer.sol` |
| WETHGateway | `/Users/z/work/lux/standard/src/alcx2/contracts/WETHGateway.sol` |
| YearnTokenAdapter | `/Users/z/work/lux/standard/src/alcx2/contracts/adapters/yearn/YearnTokenAdapter.sol` |

### Interface Locations

| Interface | Path |
|-----------|------|
| IAlchemistV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/interfaces/IAlchemistV2.sol` |
| ITransmuterV2 | `/Users/z/work/lux/standard/src/alcx2/contracts/interfaces/transmuter/ITransmuterV2.sol` |
| IAlchemicToken | `/Users/z/work/lux/standard/src/alcx2/contracts/interfaces/IAlchemicToken.sol` |
| ITokenAdapter | `/Users/z/work/lux/standard/src/alcx2/contracts/interfaces/ITokenAdapter.sol` |

### Library Locations

| Library | Path | Description |
|---------|------|-------------|
| FixedPointMath | `libraries/FixedPointMath.sol` | Fixed-point arithmetic |
| Limiters | `libraries/Limiters.sol` | Rate limiting |
| LiquidityMath | `libraries/LiquidityMath.sol` | Liquidity calculations |
| SafeCast | `libraries/SafeCast.sol` | Safe type casting |
| Sets | `libraries/Sets.sol` | Address set operations |
| Tick | `libraries/Tick.sol` | Transmuter tick management |
| TokenUtils | `libraries/TokenUtils.sol` | Token transfer utilities |

### Build and Test

```bash
cd /Users/z/work/lux/standard

# Build
forge build

# Run tests
forge test --match-path test/alcx2/**/*.t.sol -vvv

# Gas report
forge test --match-path test/alcx2/**/*.t.sol --gas-report

# Coverage
forge coverage --match-path test/alcx2/**/*.t.sol
```

## Security Considerations

### Smart Contract Risks

1. **Yield Source Risk**: If a yield source fails or is exploited, collateral may be lost
   - Mitigation: Multiple yield sources, maximum exposure limits per source

2. **Oracle Risk**: Incorrect price feeds could enable undercollateralized minting
   - Mitigation: Multiple price sources, sanity checks, circuit breakers

3. **Flash Loan Attacks**: Flash mints could manipulate protocol state
   - Mitigation: Reentrancy guards, state checks after external calls

4. **Admin Key Risk**: Admin functions could be abused
   - Mitigation: Timelock, multisig, eventual governance decentralization

### Yield Source Risks

| Risk | Mitigation |
|------|------------|
| Yield source hack | Per-source deposit caps |
| Yield source pause | Multiple yield sources per underlying |
| Yield source depegging | Maximum loss limits, automatic disable |
| Smart contract bug | Audited adapters only |

### Cross-Chain Risks

1. **Warp Message Failure**: Messages may fail to deliver
   - Mitigation: Retry mechanism, refund on failure

2. **Chain Reorganization**: Reorgs could double-spend synthetic tokens
   - Mitigation: Wait for finality before crediting cross-chain transfers

### Audit Status

Original Alchemix V2 audits:
- Runtime Verification (2021)
- Code4rena Contest (2022)

Lux fork requires:
- [ ] Internal security review
- [ ] External audit of Lux-specific changes
- [ ] Cross-chain integration audit

## Economic Impact

### Protocol Revenue

| Source | Rate | Recipient |
|--------|------|-----------|
| Harvest Fee | 10% of yield | Treasury |
| Flash Mint Fee | 0% (configurable) | Treasury |
| Liquidation | 0% (self-liquidation) | User |

### User Economics

**Example: 1000 USDC deposit at 5% APY**:
- Max borrow: 500 alUSD
- Annual yield: $50
- Time to full repayment: ~10 years (without additional deposits)
- Time to 50% repayment: ~5 years

**Comparison to Traditional Lending**:
| Protocol | Borrow Rate | Liquidation Risk | Management |
|----------|-------------|------------------|------------|
| Alchemix | 0% (self-repaying) | None | Passive |
| Aave | 2-10% variable | Yes | Active |
| Compound | 2-8% variable | Yes | Active |

### TVL Projections

Based on Lux DeFi ecosystem growth:
| Phase | Target TVL | Synthetic Supply |
|-------|------------|------------------|
| Launch | $10M | $5M |
| 6 months | $50M | $25M |
| 1 year | $200M | $100M |

## Open Questions

1. **Governance Token**: Should Lux deploy a native governance token for protocol decisions, or use LUX?

2. **sLUX Integration**: Exact mechanics for sLUX (staked LUX) as collateral need definition based on P-Chain staking design.

3. **Cross-Chain Canonical**: Which chain should be canonical for each synthetic token? Proposal: C-Chain for all.

4. **Fee Distribution**: Should harvest fees go to Treasury, stakers, or LP providers?

## Related Standards

| LP | Title | Relationship |
|----|-------|--------------|
| LP-20 | LRC-20 Token Standard | Base token interface |
| LP-2000 | C-Chain EVM Specification | Deployment chain |
| LP-6022 | Warp Messaging 2.0 | Cross-chain synthetics |
| LP-9072 | Bridged Asset Standard | Cross-chain token pattern |
| LP-4200 | Post-Quantum Cryptography | Future signature migration |

## References

1. [Alchemix V2 Documentation](https://alchemix-finance.gitbook.io/v2/)
2. [Alchemix V2 GitHub](https://github.com/alchemix-finance/v2-foundry)
3. [Alchemix Audits](https://github.com/alchemix-finance/v2-foundry/tree/master/audits)
4. [Original Alchemix Whitepaper](https://alchemix.fi/whitepaper)

## Copyright

Copyright and related rights waived via [GPL-3.0](https://www.gnu.org/licenses/gpl-3.0.html).
